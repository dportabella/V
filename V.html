<!DOCTYPE html >
<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <title>V</title>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>
  <script src="http://www.google.com/jsapi" type="text/javascript"></script>
  <script type="text/javascript">google.load('search', '1');</script>
  <script type="text/javascript">

/*
http://code.google.com/apis/maps/documentation/javascript/
http://www.garshol.priv.no/blog/17.html
http://code.google.com/apis/maps/articles/phpsqlajax_v3.html
http://code.google.com/apis/maps/documentation/javascript/examples/index.html

http://labs.google.com/ridefinder/images/mm_20_blue.png'
http://labs.google.com/ridefinder/images/mm_20_shadow.png

geocoding:
http://code.google.com/apis/maps/documentation/geocoding/
http://maps.googleapis.com/maps/api/geocode/json?address=1600+Amphitheatre+Parkway,+Mountain+View,+CA&sensor=false
*/

  var map;
  var spherical;
  var geocoder;
  var markers = [];

  function init() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: new google.maps.LatLng(46.5234571,6.6327518),
      zoom: 19,
//      mapTypeId: 'roadmap'
      mapTypeId: 'hybrid'
    });

    spherical = google.maps.geometry.spherical; 
        
    geocoder = new google.maps.Geocoder();

    google.maps.event.addListener(map, 'click', function(event) {
      setField("lng", event.latLng.lng());
      setField("lat", event.latLng.lat());
      setTimeout("showV()", 100);
    });
    
    useHashParameters();
    
    showV();
  }

  function clearMarkets() {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(null);
    } 
    markers = []; 
  }

  function addMarker(point) {
    var icon = { icon: 'mm_20_blue.png', shadow: 'mm_20_shadow.png'};
    var marker = new google.maps.Marker({
      map: map,
      position: point,
      icon: icon.icon,
      shadow: icon.shadow
    });
    markers.push(marker);
  }

  function getNumber(id) {
    var num = parseFloat(document.getElementById(id).value);
    if (num == NaN) {
      // todo: show validation error
    }
    return num;
  }
  
  function setField(id, value) {
    document.getElementById(id).value = value;
  }

  function showV() {
    clearMarkets();
    var lat = getNumber("lat");
    var lng = getNumber("lng");
    var cols = getNumber("cols");
    var rows = getNumber("rows");
    var heading = getNumber("heading");
    var angle = getNumber("angle");
    var offsetCol = getNumber("offsetCol");
    var offsetRow = getNumber("offsetRow");
    
    if (isNaN(lat) || isNaN(lng) || isNaN(cols) || isNaN(rows) || isNaN(heading) || isNaN(angle) || isNaN(offsetCol) || isNaN(offsetRow)) {
      setField("nbrPersons", "valors incorrectes");
      return;
    }
    
    setField("nbrPersons", cols * rows * 2);
    var initPoint = new google.maps.LatLng(lat, lng);

    for (var row = 0; row < rows; row++) {
      for (var col = 0; col < cols; col++) {
        addMarker(spherical.computeOffset(spherical.computeOffset(initPoint, offsetCol*col, heading-90), offsetRow*row, heading-angle/2));
        addMarker(spherical.computeOffset(spherical.computeOffset(initPoint, offsetCol*col, heading+90), offsetRow*row, heading+angle/2));
      }
    }
    
    window.location.hash = "#lat=" + lat + "&lng=" + lng + "&cols=" + cols + "&rows=" + rows + "&heading=" + heading + "&angle=" + angle + "&offsetCol=" + offsetCol + "&offsetRow=" + offsetRow;
  }
  
  function useHashParameters() {
    var re = /^lat=([\d.]+)&lng=([\d.]+)&cols=([\d.]+)&rows=([\d.]+)&heading=([\d.]+)&angle=([\d.]+)&offsetCol=([\d.]+)&offsetRow=([\d.]+)$/;
    var found = window.location.hash.substring(1).match(re);
    if (!found) {
      return;
    }
    setField("lat", found[1]);
    setField("lng", found[2]);
    setField("cols", found[3]);
    setField("rows", found[4]);
    setField("heading", found[5]);
    setField("angle", found[6]);
    setField("offsetCol", found[7]);
    setField("offsetRow", found[8]);
  }
  
  // view-source:http://code.google.com/apis/maps/documentation/javascript/examples/geocoding-simple.html
  function codeAddress() {
    var address = document.getElementById("address").value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        map.setZoom(20);
        var marker = new google.maps.Marker({
            map: map, 
            position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }
  </script>
  </head>

  <body onload="init()">
    START.<BR>
    <input id="address" type="textbox" value="Place de la Riponne, Lausanne, Switzerland">
    <input type="button" value="Go" onclick="codeAddress()">

    lat: <input id="lat" value="46.52332" size="10" onchange="showV()">, 
    lng: <input id="lng" value="6.63285" size="10" onchange="showV()">, 
    columnes: <input id="cols" value="3" size="3" onchange="showV()">, 
    files: <input id="rows" value="40" size="4" onchange="showV()">, 
    direccio en graus: <input id="heading" value="25" size="3" onchange="showV()">,
    angle: <input id="angle" value="30"  size="3" onchange="showV()">,
    distancia col en metres: <input id="offsetCol" value="1" size="2" onchange="showV()">,
    distancia fila en metres: <input id="offsetRow" value="1" size="2" onchange="showV()">,
    total persones: <input id="nbrPersons" size="20" readonly>

    <div id="map" style="width: 90%; height: 800px"></div>
    END.
  </body>
</html>
